# Bug Report - Attendix Settings Tab
Generiert: 24.02.2026
Scope: Settings Feature (`lib/features/settings/`)

## Zusammenfassung

| Kategorie | KRITISCH | HOCH | MITTEL | NIEDRIG | Gesamt |
|-----------|----------|------|--------|---------|--------|
| Security | 9 | 0 | 0 | 0 | 9 |
| Business-Logik | 2 | 3 | 4 | 2 | 11 |
| Funktional | 1 | 1 | 4 | 4 | 10 |
| Runtime | 1 | 2 | 5 | 4 | 12 |
| **Gesamt** | **13** | **6** | **13** | **10** | **42** |

## Handlungsempfehlungen

1. **SOFORT:** 9 kritische Security-Bugs fixen - Multi-Tenant Violations!
2. **SOFORT:** 4 weitere kritische Bugs (Business-Logik, Funktional, Runtime)
3. **Diese Woche:** 6 hohe Bugs fixen
4. **Backlog:** 23 mittlere/niedrige Bugs

---

## KRITISCH (13 Bugs)

### SEC-001: Player Approval ohne tenantId Filter
- **Kategorie:** Security
- **Datei:** `lib/features/settings/presentation/pages/pending_players_page.dart:126-129`
- **Problem:** Update-Query beim Genehmigen eines Spielers filtert nicht nach tenantId. Angreifer könnte Spieler anderer Tenants genehmigen.
- **Fix:** `.eq('tenantId', tenantId)` hinzufügen
- **Status:** [ ] Offen

### SEC-002: Player Deletion ohne tenantId Filter
- **Kategorie:** Security
- **Datei:** `lib/features/settings/presentation/pages/pending_players_page.dart:166-170`
- **Problem:** Delete-Query filtert nicht nach tenantId. Angreifer könnte Spieler anderer Tenants löschen.
- **Fix:** `.eq('tenantId', tenantId)` hinzufügen
- **Status:** [ ] Offen

### SEC-003: Role Update ohne tenantId Filter
- **Kategorie:** Security
- **Datei:** `lib/features/settings/presentation/pages/user_management_page.dart:545-549`
- **Problem:** TenantUser Role-Update filtert nur nach user.id, nicht nach tenantId. Cross-Tenant Role-Manipulation möglich.
- **Fix:** `.eq('tenantId', tenantId)` hinzufügen
- **Status:** [ ] Offen

### SEC-004: Cross-Tenant Player Lookup
- **Kategorie:** Security
- **Datei:** `lib/features/settings/presentation/pages/user_management_page.dart:123-127`
- **Problem:** Player-Lookup by Email sucht über ALLE Tenants - Data Exposure Vulnerability.
- **Fix:** Supabase RPC-Funktion verwenden oder Tenant-Beziehung prüfen
- **Status:** [ ] Offen

### SEC-005: Attendance Type Reorder ohne tenant_id
- **Kategorie:** Security
- **Datei:** `lib/features/settings/presentation/pages/attendance_types_page.dart:133-137`
- **Problem:** Reorder-Update filtert nicht nach tenant_id. Cross-Tenant Manipulation möglich.
- **Fix:** `.eq('tenant_id', tenantId)` hinzufügen
- **Status:** [ ] Offen

### SEC-006: deletePlayer ohne tenantId
- **Kategorie:** Security
- **Datei:** `lib/data/repositories/player_repository.dart:306-311`
- **Problem:** Repository-Methode deletePlayer() filtert nicht nach tenantId.
- **Fix:** `.eq('tenantId', currentTenantId)` hinzufügen
- **Status:** [ ] Offen

### SEC-007: approvePlayer ohne tenantId
- **Kategorie:** Security
- **Datei:** `lib/data/repositories/player_repository.dart:553-558`
- **Problem:** Repository-Methode approvePlayer() filtert nicht nach tenantId.
- **Fix:** `.eq('tenantId', currentTenantId)` hinzufügen
- **Status:** [ ] Offen

### SEC-008: archivePlayer ohne tenantId
- **Kategorie:** Security
- **Datei:** `lib/data/repositories/player_repository.dart:258-265`
- **Problem:** Repository-Methode archivePlayer() filtert nicht nach tenantId.
- **Fix:** `.eq('tenantId', currentTenantId)` hinzufügen
- **Status:** [ ] Offen

### SEC-009: reactivatePlayer ohne tenantId
- **Kategorie:** Security
- **Datei:** `lib/data/repositories/player_repository.dart:292-298`
- **Problem:** Repository-Methode reactivatePlayer() filtert nicht nach tenantId.
- **Fix:** `.eq('tenantId', currentTenantId)` hinzufügen
- **Status:** [ ] Offen

### BL-001: Selbstentrechtung möglich
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/user_management_page.dart:540-549`
- **Problem:** Admin kann eigene Rolle ändern und sich selbst aussperren.
- **Fix:** Prüfung `user.userId == currentUserId` hinzufügen
- **Status:** [ ] Offen

### BL-002: Letzter Admin kann entfernt werden
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/user_management_page.dart:540-549`
- **Problem:** Letzter Admin kann zu einer anderen Rolle geändert werden - Tenant ohne Verwaltung.
- **Fix:** Admin-Count prüfen bevor Rolle geändert wird
- **Status:** [ ] Offen

### FN-008 / RT-005: Null-Pointer bei tenant.id
- **Kategorie:** Funktional/Runtime (Duplikat)
- **Datei:** `lib/features/settings/presentation/pages/pending_players_page.dart:22`
- **Problem:** `tenant.id!` Force-Unwrap kann crashen wenn tenant.id null.
- **Fix:** `if (tenant == null || tenant.id == null) return [];`
- **Status:** [ ] Offen

### RT-001 / FN-001 / BL-003: Substring auf kurzem String
- **Kategorie:** Runtime/Funktional/Business (Duplikat)
- **Datei:** `lib/features/settings/presentation/pages/settings_page.dart:38-40`
- **Problem:** `substring(0, 2)` auf String mit weniger als 2 Zeichen wirft RangeError.
- **Fix:** Längenprüfung vor substring
- **Status:** [ ] Offen

---

## HOCH (6 Bugs)

### BL-004: Default-Status außerhalb verfügbarer Status
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/attendance_type_edit_page.dart:272-285`
- **Problem:** Default-Status kann auf nicht mehr verfügbaren Status zeigen.
- **Fix:** Validierung im Dropdown: `_availableStatuses.contains(_defaultStatus)`
- **Status:** [ ] Offen

### BL-005: Telegram Chat-ID Validierung fehlt
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/notification_settings_page.dart:417-421`
- **Problem:** Chat-ID wird nicht auf numerisches Format validiert.
- **Fix:** `int.tryParse(trimmed)` Validierung hinzufügen
- **Status:** [ ] Offen

### RT-002: Unsafe .first auf leerer Options-Liste
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:764`
- **Problem:** `options.first` wirft StateError bei leerer Liste.
- **Fix:** `options.isNotEmpty ? options.first : ''`
- **Status:** [ ] Offen

### RT-003: Unsafe .first beim Edit-Dialog
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:930`
- **Problem:** Gleiche Problematik wie RT-002 beim Speichern.
- **Fix:** `options.isNotEmpty` Check hinzufügen
- **Status:** [ ] Offen

### FN-004: User-Email immer "Unbekannt"
- **Kategorie:** Funktional
- **Datei:** `lib/features/settings/presentation/pages/user_management_page.dart:499`
- **Problem:** `tenantUsersProvider` lädt kein email-Feld, daher immer "Unbekannt".
- **Fix:** Separate Query für E-Mails aus player-Tabelle
- **Status:** [ ] Offen

---

## MITTEL (13 Bugs)

### BL-006: Race Condition bei Doppelklick
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/pending_players_page.dart:104-141`
- **Problem:** Kein Loading-State bei Approve/Reject - Doppelklick führt zu doppelter Aktion.
- **Fix:** `_processingIds` Set einführen
- **Status:** [ ] Offen

### BL-007: Field-ID Kollision
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:593-598`
- **Problem:** "E-Mail" und "Email" erzeugen gleiche ID.
- **Fix:** Counter-Suffix für Duplikate hinzufügen
- **Status:** [ ] Offen

### BL-008: Reorder-Änderungen verloren bei Fehler
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/attendance_types_page.dart:127-154`
- **Problem:** Bei Netzwerkfehler werden lokale Änderungen verworfen.
- **Fix:** Reorder-Modus bei Fehler NICHT beenden
- **Status:** [ ] Offen

### BL-009: Ungültige Rollen im Dropdown
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/user_management_page.dart:218-227`
- **Problem:** voiceLeader/voiceLeaderHelper fehlen, manche Rollen sinnlos.
- **Fix:** Rollen-Liste anpassen
- **Status:** [ ] Offen

### FN-002: Doppelter setState in _selectSeasonStart
- **Kategorie:** Funktional
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:204-208`
- **Problem:** `_markChanged()` in setState ruft erneut setState auf.
- **Fix:** Direkt `_hasChanges = true` setzen
- **Status:** [ ] Offen

### FN-003: Manuelle NotificationConfig-Rekonstruktion
- **Kategorie:** Funktional
- **Datei:** `lib/features/settings/presentation/pages/notification_settings_page.dart:424-439`
- **Problem:** Bei _disconnectTelegram wird Config manuell rekonstruiert - fehleranfällig.
- **Fix:** Dedizierte clearTelegramChatId() Methode
- **Status:** [ ] Offen

### FN-005: Status als name statt value gespeichert
- **Kategorie:** Funktional
- **Datei:** `lib/features/settings/presentation/pages/attendance_type_edit_page.dart:466-467`
- **Problem:** Status wird als String-Name gespeichert, nicht als Integer-Value.
- **Fix:** Einheitlich `.value` verwenden
- **Status:** [ ] Offen

### FN-010: Alle Rollen in PopupMenu angezeigt
- **Kategorie:** Funktional
- **Datei:** `lib/features/settings/presentation/pages/user_management_page.dart:503-509`
- **Problem:** voiceLeader/voiceLeaderHelper ohne Stimmkonfiguration zuweisbar.
- **Fix:** Diese Rollen aus Dropdown entfernen
- **Status:** [ ] Offen

### RT-004: Unsafe tenant!.id! Force-Unwrap
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:168`
- **Problem:** Doppelter Force-Unwrap ist riskant.
- **Fix:** Variable vor Check extrahieren
- **Status:** [ ] Offen

### RT-006: Unsafe player.id! Force-Unwrap
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/pending_players_page.dart:129`
- **Problem:** player.id kann null sein.
- **Fix:** Null-Check vor Verwendung
- **Status:** [ ] Offen

### RT-007: Unsafe player.id! beim Löschen
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/pending_players_page.dart:170`
- **Problem:** Gleiche Problematik wie RT-006.
- **Fix:** Null-Check hinzufügen
- **Status:** [ ] Offen

### RT-008: Unnötiger Force-Unwrap nach null-Check
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/attendance_types_page.dart:137`
- **Problem:** Stilistisch: Nach `if (type.id != null)` ist `!` überflüssig.
- **Fix:** Variable vor Check extrahieren
- **Status:** [ ] Offen

---

## NIEDRIG (10 Bugs)

### BL-010: Doppelter _markChanged() Aufruf
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:204-208`
- **Problem:** Unnötiger doppelter Widget-Rebuild.
- **Fix:** Direkt `_hasChanges = true` setzen
- **Status:** [ ] Offen

### BL-011: Fehlende Erklärung bei null tenant.id
- **Kategorie:** Business-Logik
- **Datei:** `lib/features/settings/presentation/pages/calendar_subscription_page.dart:20-21`
- **Problem:** Bei null tenant.id wird nichts angezeigt, keine Erklärung.
- **Fix:** Hinweis-Text anzeigen
- **Status:** [ ] Offen

### FN-006: Inkonsistente Status-Speicherung
- **Kategorie:** Funktional
- **Datei:** `lib/features/settings/presentation/pages/attendance_types_page.dart:203-224`
- **Problem:** Neue Types speichern `.value`, Edit speichert `.name`.
- **Fix:** Einheitlich eine Variante verwenden
- **Status:** [ ] Offen

### FN-007: Toast nach Dialog-Close
- **Kategorie:** Funktional
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:780`
- **Problem:** Toast mit parent-context nach Dialog-close kann crashen.
- **Fix:** `if (mounted)` Check hinzufügen
- **Status:** [ ] Offen

### FN-009: Fehlender const Constructor
- **Kategorie:** Funktional
- **Datei:** `lib/features/settings/presentation/pages/calendar_subscription_page.dart:170`
- **Problem:** _PlatformInstructions könnte const sein, ist es aber nicht.
- **Fix:** `const` hinzufügen
- **Status:** [ ] Offen

### RT-009: Null-Handling bei _disconnectTelegram
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/notification_settings_page.dart:424-440`
- **Problem:** `_config!` ist unsicher wenn _config null.
- **Fix:** Null-Check am Anfang der Methode
- **Status:** [ ] Offen

### RT-010: .first auf potenziell leerer Set
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/attendance_type_edit_page.dart:281`
- **Problem:** Nach Status-Entfernung könnte Set leer sein.
- **Fix:** `isNotEmpty` Check hinzufügen
- **Status:** [ ] Offen

### RT-011: Memory Leak - TextEditingController nicht disposed
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:780`
- **Problem:** Controller in BottomSheet werden nicht disposed.
- **Fix:** Nach showModalBottomSheet disposen
- **Status:** [ ] Offen

### RT-012: Memory Leak - Edit-Dialog Controller
- **Kategorie:** Runtime
- **Datei:** `lib/features/settings/presentation/pages/general_settings_page.dart:797`
- **Problem:** Gleiche Problematik wie RT-011 für Edit-Dialog.
- **Fix:** Controller disposen
- **Status:** [ ] Offen

---

## Duplikate (zusammengefasst)

Die folgenden Bugs wurden von mehreren Scannern gemeldet und sind oben als ein Bug geführt:

| Zusammengefasst als | Ursprüngliche IDs |
|---------------------|-------------------|
| FN-008 / RT-005 | FN-008, RT-005 |
| RT-001 / FN-001 / BL-003 | RT-001, FN-001, BL-003 |

---

## Positive Findings (korrekt implementiert)

Folgende Bereiche haben korrektes tenantId-Filtering:
- `tenantUsersProvider` (user_management_page.dart:51-55)
- `pendingPlayersProvider` (pending_players_page.dart:19-24)
- `leftPlayersProvider` (left_players_page.dart:13-16)
- `attendanceTypesProvider`
- `_attendanceTypeByIdProvider` (attendance_type_edit_page.dart:17-31)
- Attendance type edit/delete (attendance_type_edit_page.dart:450-500)
- `notificationConfigProvider`
- General settings save (general_settings_page.dart:145-168)

---

## Scan-Details

- **Gescannte Dateien:** 9 Settings-Seiten + 1 Repository
- **Scanner verwendet:** business-logic, functional, runtime, security
- **Duplikate entfernt:** 4

---

## Nächste Schritte

1. **SOFORT:** 9 kritische Security-Bugs in player_repository.dart und Settings-Seiten fixen
2. **SOFORT:** Business-Logik Bugs BL-001/BL-002 (Admin-Schutz)
3. **SOFORT:** Runtime-Crash RT-001 (substring auf kurzem String)
4. **Dann:** Hohe Bugs (6 Stück) - besonders FN-004 (E-Mail nie angezeigt)
5. Mittlere/Niedrige Bugs ins Backlog aufnehmen
6. Nach Fixes: Bug-Hunt wiederholen zur Verifikation
